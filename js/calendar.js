/*! <anderpang@foxmail.com> */
"use strict";!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():e.Calendar=t()}(this,function(){function e(e){this.config(e||{}).init()}return e.prototype={noop:function(){},checkDate:function(e,t){return!(e<t[0]||e>t[1])},getDateFromObj:function(e){return 1e4*e.getFullYear()+100*(e.getMonth()+1)+e.getDate()},config:function(e){var t,i,a,n,s=document,d=e.limits,l=[10000101,99990101];return this.el="string"==typeof e.el?s.querySelector(e.el):e.el,"number"==typeof(t=e.today)?this.checkDate(t,l)?this._today=t:this._today=this.getDateFromObj(new Date):t instanceof Date?this._today=this.getDateFromObj(t):this._today=this.getDateFromObj(new Date),"number"==typeof(n=e.selected)?this._selected_day=n:n instanceof Date?this._selected_day=this.getDateFromObj(n):this._selected_day=0,this._limits=l,d&&("number"==typeof(n=d[0])?n>l[0]&&n<l[1]&&(l[0]=n):n instanceof Date&&(l[0]=this.getDateFromObj(n)),"number"==typeof(n=d[1])?n>l[0]&&n<l[1]&&(l[1]=n):n instanceof Date&&(l[1]=this.getDateFromObj(n)),l[0]>l[1]&&(l[0]+=l[1],l[1]=l[0]-l[1],l[0]-=l[1])),a=((n=Math.max(this._today,l[0]))-1e4*(i=n/1e4|0))/100-1|0,this._cur_date=[i,a],this._showIndex=0,this.onSelected=e.onSelected||this.noop,this.onChange=e.onChange||this.noop,this},renderCells:function(e){for(var t=this.shows[(this._showIndex%3+3)%3].children,i=this._cur_date,a=i[0],n=i[1]+1,s=1,d=0,l=t.length;d<l;d++)t[d].innerHTML&&e(t[d],a,n,s++);return this},init:function(){var i=document.createElement("div"),e=function(e){var t=i.cloneNode(!0);return t.className=e,t},t=e("cld-header"),a=e("cld-main"),n=e("cld-year-bar"),s=e("cld-date-bar"),d=e("cld-mon-bar"),l=e("cld-week-bar"),r=e("cld-date-inner cld-anim"),h=e("cld-year-show"),c=e("cld-mon-show"),o=e("cld-today-show"),u=[this.initDateShow()];return u[1]=u[0].cloneNode(!0),u[2]=u[0].cloneNode(!0),this.header=t,this.main=a,this.yearBar=n,this.monthBar=d,this.dateInner=r,this.yearShow=h,this.monShow=c,this.shows=u,o.innerHTML="今天",t.appendChild(e("cld-move-left")),t.appendChild(h),t.appendChild(c),t.appendChild(o),t.appendChild(e("cld-move-right")),this.initWeek(l).fillDate(u[0],0).fillDate(u[1],1).fillDate(u[2],-1).updateHeader(),r.appendChild(u[0]),r.appendChild(u[1]),r.appendChild(u[2]),s.appendChild(l),s.appendChild(r),a.appendChild(n),a.appendChild(s),a.appendChild(d),i.appendChild(t),i.appendChild(a),i.className="calendar-wrap",i.addEventListener("click",this,!1),void 0!==s.ontouchstart?(this.evts.touchcancel=this.evts.touchend,s.addEventListener("touchstart",this,!1),s.addEventListener("touchmove",this,!1),s.addEventListener("touchend",this,!1),s.addEventListener("touchcancel",this,!1)):(this.evts.mouseleave=this.evts.mouseup,s.addEventListener("mousedown",this,!1),s.addEventListener("mousemove",this,!1),s.addEventListener("mouseup",this,!1),s.addEventListener("mouseleave",this,!1)),this.el.appendChild(i),this},handleEvent:function(e){var t,i,a=e.type;if("click"===a){if(this._disableClick)return void(this._disableClick=!1);(i=(t=e.target).className)&&("cld-date-cell cld-date-today"===i?this.evts["cld-date-cell"].call(this,t,e):this.evts[i]&&this.evts[i].call(this,t,e))}else this.evts[a]&&this.evts[a].call(this,e)},evts:{"cld-date-cell":function(e,t){var i,a=e._date;t.preventDefault(),t.stopPropagation(),this._selected_day=a,(i=this.dateInner.querySelector(".cld-date-sel"))&&i.classList.remove("cld-date-sel"),e.classList.add("cld-date-sel"),this.triggerSelected()},"cld-move-left":function(e,t){var i=--this._showIndex,a=this._cur_date,n=a[0],s=a[1];t.stopPropagation(),1e3!==n||0!==s?(this.setTranslate(this.dateInner,"translate3d("+-100*i+"%,0,0)"),0===s?(s=11,a[0]--):s--,this.changeMonth(s).updateHeader().fillDate(this.shows[(i%3+3-1)%3],-1)):this._showIndex++},"cld-move-right":function(e,t){var i=++this._showIndex,a=this._cur_date,n=a[0],s=a[1];t.stopPropagation(),9999!==n||11!==s?(this.setTranslate(this.dateInner,"translate3d("+-100*i+"%,0,0)"),11===s?a[s=0]++:s++,this.changeMonth(s).updateHeader().fillDate(this.shows[(i%3+3+1)%3],1)):this._showIndex--},"cld-year-show":function(e,t){var i=this._cur_date[0],a=this.main,n=this.yearBar.childElementCount;t.stopPropagation(),this._year_page=0,n?this.fillYear(i,0):this.initYearBar(i),this.setTranslate(a,"translate3d(0,100%,0)")},"cld-mon-show":function(e,t){var i,a,n=this._cur_date[1],s=this.main,d=this.monthBar.childElementCount;t.stopPropagation(),d?(a=this.monInner.querySelector(".cld-cur-mon"))!==(i=this.monInner.children)[n]&&(a.classList.remove("cld-cur-mon"),i[n].classList.add("cld-cur-mon")):this.initMonthBar(n),this.setTranslate(s,"translate3d(0,-100%,0)")},"cld-today-show":function(e,t){var i=this._cur_date,a=this._today,n=a/1e4|0,s=(a-1e4*n)/100-1|0;t.stopPropagation(),i[0]!==n||i[1]!==s?(i[0]=n,i[1]=s,this.dateReset().updateHeader().moveToDateBar()):this.moveToDateBar()},"cld-back-btn":function(e,t){t.stopPropagation(),this.moveToDateBar()},"cld-year-prev":function(e,t){var i=this._cur_date[0];t.stopPropagation(),this._year_page++,this.fillYear(i,-1)},"cld-year-next":function(e,t){var i=this._cur_date[0];t.stopPropagation(),this._year_page--,this.fillYear(i,1)},"cld-year-cell":function(e,t){var i=this._cur_date,a=1*e.innerHTML;i[0]=a,i[1]=0,this.dateReset().updateHeader().moveToDateBar()},"cld-mon-cell":function(e,t){var i=this._cur_date,a=e.innerHTML-1;i[1]=a,this.dateReset().updateHeader().moveToDateBar()},mousedown:function(e){var t=e.currentTarget;this._ow=t.clientWidth,this._cy=e.clientY,this._cx=e.clientX,this._startTime=e.timeStamp,this._is_down=!0,this._disableClick=!1,this.dateInner.classList.remove("cld-anim")},mousemove:function(e){if(this._is_down){var t=e.clientY-this._cy,i=e.clientX-this._cx,a=Math.abs(i);Math.abs(t)<a&&this.setTranslate(this.dateInner,"translate3d("+(-this._showIndex*this._ow+i-a/(2*this._ow)*i)+"px,0,0)")}},mouseup:function(e){if(this._is_down){var t=this.dateInner,i=Math.abs(e.clientY-this._cy),a=e.clientX-this._cx,n=Math.abs(a),s=e.timeStamp-this._startTime,d=100*this._cur_date[0]+this._cur_date[1];if(e.stopPropagation(),this._is_down=!1,t.classList.add("cld-anim"),t.offsetWidth,i<n&&(s<300||n>.2*this._ow))if(this._disableClick=!0,0<a){if(1e5!==d)return void this.evts["cld-move-left"].call(this,t,e)}else if(999911!==d)return void this.evts["cld-move-right"].call(this,t,e);this.setTranslate(t,"translate3d("+-100*this._showIndex+"%,0,0)"),5<i+n&&(this._disableClick=!0)}},touchstart:function(e){var t=e.targetTouches[0];e.clientX=t.clientX,e.clientY=t.clientY,this.evts.mousedown.call(this,e)},touchmove:function(e){var t=e.targetTouches[0];e.clientX=t.clientX,e.clientY=t.clientY,this.evts.mousemove.call(this,e)},touchend:function(e){var t=e.changedTouches[0];e.clientX=t.clientX,e.clientY=t.clientY,this.evts.mouseup.call(this,e),this._disableClick=!1}},setTranslate:function(e,t){return e.style.transform=e.style.webkitTransform=t,this},moveToDateBar:function(){return this.setTranslate(this.main,"translate3d(0,0,0)"),this},initDateShow:function(){var e=document.createElement("div"),t=e.cloneNode(!1),i=41;for(t.className="cld-date-cell",e.className="cld-date-show",e.appendChild(t);i--;)e.appendChild(t.cloneNode(!0));return e},weeks:["日","一","二","三","四","五","六"],initWeek:function(e){var t=document.createElement("span"),i=this.weeks,a=1,n=i.length;for(t.className="cld-week-cell",t.innerHTML=i[0],e.appendChild(t);a<n;a++)(t=t.cloneNode(!0)).innerHTML=i[a],e.appendChild(t);return this},fillDate:function(e,t){var i,a,n,s,d,l=this._today,r=this._showIndex,h=this._selected_day,c=!!h,o=this._cur_date,u=o[0],m=o[1],p=1,_=0,f=e.children,v=f.length,y=this._limits[0],g=this._limits[1];if(e.style.display="none",(m+=t)<0?(m=11,u--):11<m&&(m=0,u++),m+=1,u<1e3||9999<u)return this;for(a=(i=new Date(u,m,0)).getDate(),n=(i.getDay()+8-a%7)%7,e._date=100*u+m;_<n;_++)(s=f[_]).innerHTML="",s.className="cld-date-cell cld-date-disabled";for(;p<=a;_++,p++)d=1e4*u+100*m+p,(s=f[_]).innerHTML=p,s._date=d,s.className=d===l?c&&d===h?"cld-date-cell cld-date-today cld-date-sel":"cld-date-cell cld-date-today":d===h?"cld-date-cell cld-date-sel":"cld-date-cell",(d<y||g<d)&&s.classList.add("cld-date-limit");for(;_<v;_++)(s=f[_]).innerHTML="",s.className="cld-date-cell cld-date-disabled";return e.style.left=100*(t+r)+"%",e.style.display="",this},updateHeader:function(){var e=this._cur_date,t=e[0],i=e[1]+1;return this.yearShow.innerHTML=t,this.monShow.innerHTML=i,this.onChange(t,i),this},changeMonth:function(e){return this._cur_date[1]=e,this},initYearBar:function(e){var t=document,i=t.createElement("span"),a=this.yearBar,n=a.cloneNode(!1),s=n.cloneNode(!1),d=i.cloneNode(!1),l=t.createDocumentFragment(),r=0;for(n.className="cld-year-header",n.innerHTML="选择年份",d.className="cld-back-btn",d.innerHTML="返回",n.appendChild(d),l.appendChild(n),s.className="cld-year-inner",i.className="cld-year-prev",i.innerHTML="往前",s.appendChild(i);r<10;r++)i=i.cloneNode(!1),s.appendChild(i);return(i=i.cloneNode(!1)).className="cld-year-next",i.innerHTML="往后",s.appendChild(i),l.appendChild(s),this.yearInner=s,this._year_page=0,a.appendChild(l),this.fillYear(e,0)},fillYear:function(e,t){var i,a,n,s=e-e%10,d=0;if((s-=10*this._year_page)<1e3||9999<s)return this._year_page+=t,this;for(i=this.yearInner.children;d<10;d++)n=s+d,(a=i[d+1]).innerHTML=n,a.className=e===n?"cld-year-cell cld-cur-year":"cld-year-cell";return this},dateReset:function(){var e=this.shows,t=this.dateInner;return this._showIndex=0,t.style.display="none",this.fillDate(e[0],0).fillDate(e[1],1).fillDate(e[2],-1).setTranslate(t,"translate3d(0,0,0)"),t.offsetHeight,t.style.display="",this},initMonthBar:function(e){var t=document,i=t.createElement("span"),a=this.monthBar,n=a.cloneNode(!1),s=n.cloneNode(!1),d=i.cloneNode(!1),l=t.createDocumentFragment(),r=0;for(n.className="cld-mon-header",n.innerHTML="选择月份",d.className="cld-back-btn",d.innerHTML="返回",n.appendChild(d),l.appendChild(n),s.className="cld-mon-inner";r<12;i=i.cloneNode(!1),r++)i.innerHTML=r+1,i.className=r===e?"cld-mon-cell cld-cur-mon":"cld-mon-cell",s.appendChild(i);return l.appendChild(s),this.monInner=s,a.appendChild(l),this},triggerSelected:function(){if(!this._selected_day)return this;var e=this._selected_day,t=e/1e4|0,i=(e-1e4*t)/100|0,a=e%100;return this.onSelected(t,i,a),this},setLimitStart:function(e){return this.setLimit(e,0)},setLimitEnd:function(e){return this.setLimit(e,1)},setLimit:function(e,t){var i,a,n,s=this._limits,d=this._cur_date;return e=e instanceof Date?this.getDateFromObj(e):Math.max(10000101,Math.min(99990101,1*e)),s[t]!==e&&(s[t]=e,i=(d=this._cur_date)[0],a=d[1]+1,n=e/100|0,(t?n<=(12===a?100*(i+1)+1:100*i+a+1):(1===a?100*(i-1)+12:100*i+a-1)<=n)&&this.dateReset().onChange(i,a)),this}},e});
